<!doctype html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="96x96" href="res/favi.png">
    <title>WhiteDragon NFT Donate</title>
    <style>
    body {
        background-color: #121212;
        color: #eee;
    }
    </style>
</head>
<body>
    <div style="display:inline-block;">
        <h2>Donations for WhiteDragon NFT</h2>
        <img src="res/favi.png" style="display:block;margin:auto"></img>
    </div>
    <br><br>
    <a id="twitch_login" href="https://id.twitch.tv/oauth2/authorize?response_type=id_token&client_id=a68m7c8h9tqrxwn1yrxydamn2v9x5f&redirect_uri=https://ryucrypt.github.io/nft/wd/donate.html&scope=openid&claims={%22id_token%22:{%22preferred_username%22:null}}"><button type="button">Twitch Login</button></a>
    <div id="twitch_in" style="display:none">
        <h4>Twitch Username: <span id="twitch"></span></h4>
        <div id="wallet_login">
            <button type="button" onclick="loginSpecificWallet('cloud');">Cloud Wallet</button>
            <button type="button" onclick="loginSpecificWallet('anchor');">Anchor</button>
            <br>
            <h4 id="error"></h4>
        </div>
    </div>
    <div id="wallet_in" style="display:none">
        <h4>Wallet: <span id="wallet"></span></h4>
        <input type="number" id="amount" oninput="restrict(this);" />
        <select id="token" onchange="updateBalance();">
        </select>
        <br>
        <span id="balance"></span>
        <br><br>
        <button type="button" id="donate" onclick="load();">Donate</button>
        <br><br>
        <h4 id="txn"></h4>
    </div>
</body>
<script src="https://unpkg.com/anchor-link@3"></script>
<script src="https://unpkg.com/anchor-link-browser-transport@3"></script>
<script src="/nft/js/waxjs.js"></script>
<script src="/nft/js/wallets.js"></script>
<script>
const TOKENS = [
    {symbol: "WAX", contract: "eosio.token", precision: 8},
    {symbol: "NBMFUS", contract: "battleminers", precision: 6},
    {symbol: "NBMACT", contract: "battleminers", precision: 6},
    {symbol: "NBMMIN", contract: "battleminers", precision: 6},
    {symbol: "NBMCON", contract: "battleminers", precision: 6},
    {symbol: "MST", contract: "metatoken.gm", precision: 8},
    {symbol: "TACO", contract: "t.taco", precision: 4},
    {symbol: "LOOT", contract: "warsaken", precision: 4},
];

var twitch = "";
var wallet = "";

if (document.location.hash != "") {
    twitch = parseJwt(document.location.hash.split("=")[1]).preferred_username;
    document.getElementById("twitch").innerHTML = twitch;
    document.getElementById("twitch_login").outerHTML = "";
    document.getElementById("twitch_in").style.display = "block";
}

const login = async() => {
    try {
        document.getElementById("error").innerHTML = "";
        wallet = await wallet_login();
        document.getElementById("wallet").innerHTML = wallet;
        document.getElementById("wallet_login").style.display = "none";
        document.getElementById("wallet_in").style.display = "block";
        await updateBalance();
    } catch(e) {
        document.getElementById('error').innerHTML = e.message;
    }
}

const loginSpecificWallet = async(walletType) => {
    wallet_selectWallet(walletType);
    login();
}

const load = async() => {
    document.getElementById("donate").disabled = true;
    var token = getToken();
    try {
        var amount = (Math.round(document.getElementById("amount").value * Math.pow(10, token.precision)/Math.pow(10, token.precision))).toFixed(token.precision);
        document.getElementById("txn").innerHTML = "";
        var actions = [{
            account: token.contract,
            name: "transfer",
            authorization: [{
                actor: wallet,
                permission: "active",
            }],
            data: {
                from: wallet,
                to: "wddonationsx",
                quantity: amount + " " + token.symbol,
                memo: "Twitch Donation from: " + twitch
            }
        }];
        console.log(actions);
        var txn = await wallet_transact(actions);
        console.log(txn);
        document.getElementById("txn").innerHTML = "Success! <a href='https://wax.bloks.io/transaction/" + txn.transaction_id + "' target='_blank'>View Transaction</a>";
        await updateBalance();
    } catch(e) {
        document.getElementById("txn").innerHTML = e.message;
    }
    document.getElementById("donate").disabled = false;
}

// Views
const setOptions = () => {
    for (let i = 0; i < TOKENS.length; i++) {
        var item = document.createElement("option");
        item.innerHTML = TOKENS[i].symbol;
        item.setAttribute("value", TOKENS[i].symbol);
        document.getElementById("token").append(item);
    }
}

const restrict = (tis) => {
    var token = getToken();
    var t = tis.value;
    tis.value = (t.indexOf(".") >= 0) ? (t.substr(0, t.indexOf(".")) + t.substr(t.indexOf("."), token.precision + 1)): t;
}

const getToken = () => {
    return TOKENS.find(o => o.symbol == document.getElementById("token").value);
}

setOptions();

// Helper
const parseJwt = (token) => {
    var base64Url = token.split(".")[1];
    var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
    var jsonPayload = decodeURIComponent(atob(base64).split("").map(function(c) {
        return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(""));

    return JSON.parse(jsonPayload);
}

const updateBalance = async() => {
    var token = getToken();
    var bal = await wax.rpc.get_currency_balance(token.contract, wallet, token.symbol);
    if (bal.length < 1) {
        document.getElementById("balance").innerHTML = "No balance";
    } else {
        document.getElementById("balance").innerHTML = "Balance: " + bal[0];
    }
}
</script>
</body>
</html>